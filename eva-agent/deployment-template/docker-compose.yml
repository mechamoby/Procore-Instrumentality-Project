# EVA Agent — Docker Compose Production Stack
# Generated by EVA deployment template
# https://github.com/evangelion-project/eva-agent

services:
  # ─── OpenClaw Agent ───────────────────────────────────────────
  openclaw:
    image: ghcr.io/evangelion-project/openclaw:latest
    container_name: eva-agent
    restart: unless-stopped
    ports:
      - "${AGENT_PORT:-3000}:3000"
    volumes:
      - ./config:/app/config:ro
      - ./config/prompts:/app/prompts:ro
      - agent-data:/app/data
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://${POSTGRES_USER:-eva}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-eva_agent}
      - REDIS_URL=redis://redis:6379
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - AGENT_CONFIG_PATH=/app/config/agent-config.yaml
      - ROLES_CONFIG_PATH=/app/config/roles.yaml
      # Procore
      - PROCORE_CLIENT_ID=${PROCORE_CLIENT_ID}
      - PROCORE_CLIENT_SECRET=${PROCORE_CLIENT_SECRET}
      - PROCORE_COMPANY_ID=${PROCORE_COMPANY_ID}
      # DocuSign
      - DOCUSIGN_INTEGRATION_KEY=${DOCUSIGN_INTEGRATION_KEY}
      - DOCUSIGN_SECRET_KEY=${DOCUSIGN_SECRET_KEY}
      - DOCUSIGN_ACCOUNT_ID=${DOCUSIGN_ACCOUNT_ID}
      # Email (SMTP)
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_FROM=${SMTP_FROM}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"

  # ─── PostgreSQL ───────────────────────────────────────────────
  postgres:
    image: postgres:16-alpine
    container_name: eva-postgres
    restart: unless-stopped
    volumes:
      - postgres-data:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-eva}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB:-eva_agent}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-eva}"]
      interval: 10s
      timeout: 5s
      retries: 5
    # Not exposed externally — only accessible within the Docker network
    # Uncomment below for debug access from the host:
    # ports:
    #   - "127.0.0.1:5432:5432"

  # ─── Redis (session store, queue) ─────────────────────────────
  redis:
    image: redis:7-alpine
    container_name: eva-redis
    restart: unless-stopped
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ─── Backup (nightly pg_dump to local volume) ─────────────────
  backup:
    image: postgres:16-alpine
    container_name: eva-backup
    restart: unless-stopped
    volumes:
      - backup-data:/backups
    environment:
      - PGHOST=postgres
      - PGUSER=${POSTGRES_USER:-eva}
      - PGPASSWORD=${POSTGRES_PASSWORD}
      - PGDATABASE=${POSTGRES_DB:-eva_agent}
    entrypoint: /bin/sh
    command: >
      -c 'while true; do
        pg_dump -Fc > /backups/eva_$(date +%Y%m%d_%H%M%S).dump;
        find /backups -name "*.dump" -mtime +30 -delete;
        sleep 86400;
      done'
    depends_on:
      postgres:
        condition: service_healthy

volumes:
  postgres-data:
    driver: local
  redis-data:
    driver: local
  agent-data:
    driver: local
  backup-data:
    driver: local

networks:
  default:
    name: eva-network
